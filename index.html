<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>User Study</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 0; padding: 0; }

    header {
      background-color: #4CAF50;
      color: white;
      padding: 10px 20px;
      text-align: center;
      position: fixed;
      width: 100%;
      top: 0;
      z-index: 1000;
    }

    .container { margin-top: 280px; padding: 20px; }

    .question { margin-bottom: 44px; text-align: center; }

    .instructions{
      max-width: 900px;
      margin: 8px auto 0;
      text-align: left;
      font-size: 1rem;
      line-height: 1.5;
    }
    .instructions ul{ margin: 8px 0 0 0; padding-left: 22px; }

    /* Table-like layout */
    .grid-wrap{
      display: inline-block;
      text-align: left;
      margin-top: 10px;
    }

    .header-row, .image-row{
      display: grid;
      grid-template-columns: repeat(8, 150px);
      align-items: center;
      column-gap: 10px;
    }

    .row-label{
      font-weight: bold;
      text-align: right;
      padding-right: 8px;
      color: #333;
      white-space: nowrap;
    }

    .col-header{
      font-weight: bold;
      text-align: center;
      font-size: 0.95rem;
      padding: 6px 4px;
      color: #1f1f1f;
    }

    .image-cell{ text-align: center; }

    .selection-image {
        cursor: pointer;
        border: 5px solid transparent;
        transition: border 0.3s;
        width: 150px;
        height: 150px;
        object-fit: cover;
    }
    .selection-image.selected {
        border: 5px solid red;
    }

    .bulk-actions{
      display: flex;
      justify-content: center;
      gap: 10px;
      margin-top: 10px;
      margin-bottom: 6px;
    }

    .mini-btn{
      background-color: #2f8f33;
      color: #fff;
      border: none;
      padding: 8px 12px;
      cursor: pointer;
      font-size: 14px;
      border-radius: 6px;
    }
    .mini-btn.secondary{
      background-color: #ffffff;
      color: #2f8f33;
      border: 1px solid rgba(255,255,255,0.0);
    }

    footer{ text-align: center; padding: 20px; }

    button{
      background-color: #4CAF50;
      color: white;
      border: none;
      padding: 10px 20px;
      cursor: pointer;
      font-size: 16px;
      border-radius: 6px;
    }

    .note{
      margin-top: 8px;
      font-size: 0.95rem;
      opacity: 0.95;
    }
  </style>
</head>

<body>
<header>
  <h1 id="pageTitle">Image Artifact Identification Study</h1>
  <div id="pageInstructions" class="instructions"></div>
</header>

<div class="container">
  <form id="surveyForm">
    <label for="name">Name: </label>
    <input type="text" id="name" required />

    <div id="questions-container"></div>

    <footer>
      <button type="button" onclick="submitSurvey()">Submit</button>
    </footer>
  </form>
</div>

<script>
  // ===== Configuration =====
  const config = {
    // Orders follow folders (no shuffle)
    folders: [
      { name: "MSPD", path: "MSPD", colTitle: "Raw" },
      { name: "PGD", path: "PGD", colTitle: "Raw" },
      { name: "MSPD-sharpen", path: "MSPD-sharpen", colTitle: "Sharpen" },
      { name: "PGD-sharpen", path: "PGD-sharpen", colTitle: "Sharpen" },
      { name: "MSPD-brightness1.5", path: "MSPD-brightness1.5", colTitle: "High Brightness" },
      { name: "MSPD-contrast1.5", path: "MSPD-contrast1.5", colTitle: "High Contrast" },
      { name: "MSPD-jpeg50", path: "MSPD-jpeg50", colTitle: "Compression" },
      { name: "MSPD-jpeg50-jpeg50", path: "MSPD-jpeg50-jpeg50", colTitle: "Multiple Compression" },
    ],

    // Exactly 20 samples
    indices: [
      0, 1, 2, 3, 4, 5, 6, 7, 8, 9,
      10, 11, 12, 13, 14, 15, 16, 17, 18, 19
    ],

    pageTitle: "Image Artifact Identification Study",
    pageInstructions:
      "Thank you for taking part in this short study (about 5 minutes).<br>" +
      "<ul>" +
      "<li>You will see <b>20 samples</b>, each containing <b>8 images</b> (one per processing condition). In addition to the raw images, we include six enhancements.</li>" +
      "<li>For each sample, please <b>select all images that contain visible artifacts</b> (e.g., contain visible noise).</li>" +
      "<li>You may select <b>multiple images</b> within the same sample.</li>" +
      "<li>Tip: use <b>Select all</b> if you think all 8 look artifacted (or <b>Clear</b> to reset a sample).</li>" +
      "<li>When finished, click <b>Submit</b>. A log file will downloadâ€”please email it to " +
      "<a style='color:white; text-decoration:underline;' href='mailto:hanrui_wang@nii.ac.jp'>hanrui_wang@nii.ac.jp</a>.</li>" +
      "<li><b>Note:</b> Refreshing the page will clear all selections.</li>" +
      "</ul>"
  };

  // Your image file list (unchanged)
  const imageFiles = ['00382_959.png', '00262_933.png', '00573_563.png', '00288_144.png', '00223_733.png', '00844_981.png', '00751_933.png', '00431_976.png', '00594_853.png', '00967_912.png', '00777_514.png', '00416_959.png', '00010_582.png', '00243_965.png', '00571_300.png', '00320_687.png', '00204_640.png', '00503_472.png', '00719_917.png', '00201_705.png', '00651_987.png', '00300_617.png', '00507_718.png', '00028_299.png', '00918_919.png', '00025_537.png', '00942_970.png', '00840_751.png', '00754_296.png', '00981_779.png', '00475_974.png', '00941_75.png', '00788_605.png', '00796_915.png', '00954_538.png', '00002_243.png', '00145_646.png', '00309_775.png', '00264_624.png', '00891_94.png', '00676_981.png', '00286_847.png', '00813_470.png', '00784_150.png', '00089_659.png', '00146_544.png', '00156_544.png', '00302_471.png', '00806_441.png', '00196_734.png', '00633_979.png', '00009_609.png', '00323_143.png', '00746_972.png', '00836_406.png', '00665_705.png', '00424_832.png', '00266_325.png', '00938_340.png', '00321_734.png', '00217_351.png', '00604_765.png', '00963_884.png', '00683_417.png', '00653_908.png', '00398_536.png', '00767_717.png', '00068_327.png', '00730_777.png', '00909_880.png', '00053_312.png', '00795_751.png', '00020_707.png', '00143_946.png', '00160_829.png', '00614_983.png', '00292_326.png', '00732_458.png', '00945_884.png', '00753_821.png', '00870_113.png', '00756_964.png', '00685_861.png', '00108_719.png', '00042_317.png', '00499_555.png', '00449_692.png', '00007_853.png', '00084_644.png', '00465_591.png', '00149_81.png', '00663_346.png', '00745_737.png', '00602_468.png', '00799_603.png', '00829_668.png', '00539_858.png', '00492_137.png', '00337_97.png', '00047_865.png', '00536_759.png', '00222_480.png', '00411_675.png', '00230_751.png', '00289_590.png', '00924_985.png', '00546_517.png', '00298_973.png', '00927_113.png', '00639_99.png', '00214_695.png', '00729_749.png', '00115_883.png', '00371_107.png', '00628_897.png', '00897_985.png', '00693_825.png', '00605_763.png', '00988_963.png', '00599_682.png', '00448_457.png', '00905_119.png', '00171_391.png', '00368_879.png', '00565_518.png', '00886_770.png', '00899_483.png', '00547_670.png', '00917_975.png', '00919_895.png', '00322_637.png', '00705_857.png', '00896_990.png', '00276_322.png', '00231_340.png', '00835_717.png', '00903_366.png', '00383_557.png', '00459_640.png', '00718_492.png', '00831_864.png', '00517_656.png', '00677_820.png', '00726_521.png', '00953_73.png', '00930_779.png', '00021_854.png', '00615_820.png', '00895_264.png', '00315_768.png', '00725_541.png', '00129_366.png', '00996_703.png', '00713_594.png', '00313_705.png', '00099_879.png', '00824_100.png', '00597_821.png', '00783_895.png', '00764_1.png', '00226_738.png', '00228_814.png', '00959_284.png', '00005_990.png', '00879_698.png', '00595_717.png', '00500_776.png', '00741_698.png', '00733_707.png', '00540_580.png', '00655_624.png', '00843_468.png', '00762_708.png', '00055_582.png', '00365_283.png', '00761_436.png', '00488_144.png', '00216_554.png', '00723_539.png', '00528_483.png', '00218_311.png', '00391_533.png', '00936_661.png', '00284_763.png', '00882_972.png', '00549_597.png', '00588_319.png', '00481_437.png', '00822_781.png', '00792_715.png', '00418_869.png', '00566_637.png', '00037_582.png', '00193_475.png', '00172_531.png', '00703_634.png', '00043_464.png', '00102_967.png', '00833_779.png', '00630_458.png', '00004_438.png', '00012_455.png', '00747_768.png', '00220_385.png', '00018_422.png', '00390_865.png', '00929_341.png', '00348_346.png', '00291_963.png', '00244_511.png', '00922_521.png', '00463_511.png', '00058_789.png', '00636_970.png', '00273_847.png', '00867_579.png', '00105_853.png', '00552_478.png', '00101_708.png', '00684_90.png', '00062_949.png', '00070_441.png', '00864_874.png', '00183_517.png', '00562_832.png', '00603_480.png', '00556_511.png', '00544_825.png', '00749_919.png', '00174_417.png', '00254_841.png', '00257_1.png', '00030_476.png', '00098_498.png', '00551_545.png', '00608_829.png', '00328_646.png', '00875_938.png', '00495_762.png', '00534_920.png', '00533_579.png', '00957_979.png', '00078_888.png', '00871_475.png', '00073_839.png', '00755_888.png', '00532_959.png', '00086_140.png', '00647_440.png', '00038_672.png', '00388_3.png', '00841_817.png', '00008_609.png', '00088_705.png', '00904_668.png', '00860_403.png', '00093_937.png', '00672_525.png', '00019_455.png', '00402_107.png', '00769_656.png', '00974_497.png', '00379_160.png', '00023_471.png', '00326_716.png', '00344_892.png', '00121_311.png', '00056_948.png', '00634_595.png', '00591_815.png', '00034_22.png', '00949_975.png', '00555_884.png', '00366_442.png', '00318_921.png', '00307_344.png', '00557_229.png', '00706_649.png', '00310_304.png', '00977_385.png', '00271_717.png', '00809_303.png', '00857_772.png', '00376_640.png', '00473_946.png', '00869_825.png', '00802_403.png', '00669_436.png', '00816_754.png', '00828_630.png', '00950_630.png', '00966_829.png', '00491_917.png', '00611_910.png', '00654_308.png', '00092_489.png', '00350_79.png', '00863_890.png', '00029_99.png', '00375_580.png', '00848_682.png', '00553_817.png', '00386_933.png', '00717_671.png', '00739_701.png', '00787_741.png', '00666_538.png', '00423_959.png', '00680_762.png', '00681_565.png', '00374_817.png', '00856_819.png', '00046_961.png', '00702_873.png', '00625_963.png', '00774_489.png', '00184_322.png', '00501_844.png', '00162_971.png', '00303_417.png', '00902_887.png', '00972_404.png', '00335_415.png', '00396_489.png', '00141_84.png', '00962_37.png', '00740_565.png', '00256_471.png', '00888_157.png', '00404_814.png', '00682_117.png', '00299_323.png', '00646_637.png', '00572_923.png', '00712_497.png', '00885_404.png', '00060_746.png', '00425_665.png', '00332_457.png', '00727_973.png', '00778_877.png', '00667_675.png', '00735_309.png', '00077_510.png', '00011_915.png', '00110_807.png', '00420_913.png', '00100_807.png', '00635_791.png', '00978_511.png', '00943_518.png', '00944_799.png', '00801_919.png', '00644_336.png', '00910_406.png', '00832_335.png', '00340_696.png', '00176_38.png', '00697_132.png', '00250_540.png', '00854_671.png', '00468_738.png', '00892_518.png', '00267_989.png', '00074_955.png', '00033_923.png', '00570_562.png', '00866_518.png', '00213_113.png', '00914_779.png', '00773_555.png', '00400_606.png', '00126_780.png', '00331_344.png', '00535_388.png', '00325_760.png', '00559_308.png', '00173_383.png', '00808_310.png', '00887_879.png', '00648_39.png', '00613_962.png', '00948_437.png', '00748_825.png', '00939_480.png', '00364_141.png', '00742_70.png', '00789_517.png', '00170_863.png', '00964_442.png', '00569_978.png', '00147_469.png', '00673_734.png', '00983_580.png', '00195_442.png', '00051_922.png', '00763_421.png', '00852_779.png', '00578_560.png', '00116_476.png', '00356_239.png', '00790_458.png', '00851_321.png', '00494_538.png', '00804_911.png', '00961_649.png', '00609_483.png', '00979_908.png', '00462_945.png', '00297_629.png', '00985_847.png', '00601_917.png', '00661_580.png', '00900_403.png', '00631_993.png', '00598_964.png', '00612_51.png', '00406_486.png', '00407_865.png', '00182_980.png', '00206_720.png', '00225_897.png', '00192_980.png', '00876_535.png', '00580_142.png', '00545_303.png', '00346_628.png', '00968_703.png', '00489_320.png', '00022_922.png', '00819_884.png', '00990_718.png', '00527_883.png', '00441_963.png', '00144_746.png', '00519_703.png', '00711_752.png', '00114_572.png', '00282_433.png', '00405_430.png', '00439_874.png', '00627_874.png', '00678_970.png', '00629_980.png', '00668_970.png', '00305_454.png', '00227_401.png', '00912_698.png', '00548_518.png', '00041_931.png', '00342_385.png', '00370_947.png', '00013_619.png', '00768_326.png', '00253_718.png', '00308_887.png', '00169_708.png', '00827_672.png', '00132_599.png', '00707_661.png', '00403_701.png', '00537_922.png', '00272_389.png', '00238_323.png', '00509_649.png', '00632_304.png', '00219_8.png', '00868_819.png', '00471_675.png', '00511_707.png', '00487_981.png', '00820_975.png', '00199_701.png', '00956_671.png', '00596_887.png', '00287_57.png', '00506_974.png', '00409_776.png', '00688_576.png', '00695_555.png', '00341_468.png', '00906_450.png', '00330_39.png', '00543_437.png', '00187_637.png', '00691_825.png', '00862_847.png', '00834_2.png', '00186_632.png', '00247_513.png', '00775_933.png', '00165_471.png', '00397_310.png', '00275_900.png', '00044_478.png', '00529_974.png', '00934_472.png', '00626_866.png', '00194_455.png', '00898_839.png', '00490_320.png', '00239_535.png', '00229_253.png', '00063_480.png', '00210_607.png', '00358_867.png', '00294_475.png', '00880_985.png', '00818_737.png', '00097_467.png', '00846_391.png', '00215_565.png', '00928_698.png', '00512_743.png', '00136_614.png', '00752_497.png', '00432_411.png', '00638_974.png', '00153_293.png', '00017_741.png', '00454_828.png', '00049_324.png', '00443_303.png', '00426_814.png', '00000_305.png', '00770_847.png', '00464_927.png', '00542_417.png', '00850_707.png', '00091_967.png', '00338_984.png', '00393_881.png', '00658_656.png', '00453_920.png', '00645_107.png', '00766_427.png', '00531_566.png', '00720_13.png', '00526_718.png', '00525_817.png', '00704_547.png', '00016_630.png', '00664_347.png', '00699_50.png', '00317_628.png', '00343_789.png', '00329_770.png', '00736_821.png', '00158_814.png', '00032_520.png', '00937_608.png', '00523_338.png', '00319_253.png', '00731_646.png', '00600_908.png', '00724_688.png', '00045_667.png', '00689_436.png', '00510_479.png', '00203_521.png', '00926_976.png', '00623_708.png', '00650_309.png', '00483_990.png', '00514_908.png', '00137_348.png', '00728_321.png', '00268_708.png', '00845_535.png', '00502_597.png', '00993_10.png', '00352_439.png', '00786_605.png', '00233_982.png', '00890_762.png', '00995_526.png', '00130_487.png', '00178_716.png', '00780_130.png', '00951_560.png', '00212_532.png', '00436_33.png', '00384_949.png', '00067_733.png', '00080_430.png', '00476_570.png', '00916_933.png', '00701_978.png', '00776_975.png', '00001_883.png', '00563_668.png', '00558_661.png', '00960_442.png', '00757_328.png', '00923_979.png', '00419_962.png', '00999_886.png', '00456_866.png', '00265_311.png', '00191_873.png', '00921_883.png', '00324_751.png', '00482_820.png', '00607_976.png', '00958_774.png', '00686_498.png', '00458_944.png', '00429_703.png', '00075_555.png', '00446_324.png', '00113_890.png', '00582_922.png', '00175_442.png', '00059_440.png', '00992_573.png', '00671_610.png', '00568_974.png', '00497_347.png', '00550_672.png', '00861_814.png', '00209_582.png', '00052_142.png', '00392_931.png', '00577_661.png', '00006_949.png', '00530_603.png', '00884_421.png', '00285_679.png', '00081_430.png', '00076_519.png', '00123_582.png', '00469_309.png', '00982_985.png', '00522_919.png', '00455_22.png', '00616_619.png', '00066_900.png', '00434_320.png', '00241_429.png', '00803_555.png', '00560_619.png', '00610_112.png', '00520_565.png', '00986_972.png', '00690_817.png', '00467_821.png', '00973_547.png', '00125_672.png', '00821_985.png', '00140_21.png', '00003_559.png', '00622_468.png', '00873_652.png', '00312_959.png', '00242_893.png', '00181_137.png', '00072_920.png', '00567_705.png', '00027_476.png', '00694_770.png', '00311_695.png', '00437_624.png', '00280_853.png', '00103_472.png', '00675_609.png', '00794_470.png', '00279_858.png', '00823_895.png', '00079_990.png', '00470_323.png', '00245_144.png', '00421_310.png', '00118_603.png', '00793_430.png', '00721_132.png', '00662_649.png', '00889_759.png', '00057_360.png', '00637_458.png', '00363_441.png', '00881_978.png', '00477_954.png', '00743_132.png', '00235_280.png', '00422_628.png', '00933_404.png', '00314_32.png', '00708_809.png', '00853_560.png', '00293_830.png', '00061_764.png', '00791_319.png', '00586_911.png', '00435_497.png', '00249_766.png', '00295_322.png', '00710_562.png', '00656_348.png', '00179_99.png', '00361_963.png', '00054_302.png', '00521_832.png', '00413_873.png', '00119_23.png', '00128_685.png', '00246_734.png', '00715_547.png', '00618_665.png', '00480_9.png', '00155_416.png', '00026_672.png', '00251_990.png', '00389_830.png', '00224_324.png', '00050_33.png', '00975_930.png', '00515_114.png', '00138_323.png', '00971_483.png', '00124_16.png', '00281_303.png', '00989_671.png', '00065_792.png', '00931_489.png', '00765_13.png', '00811_718.png', '00593_538.png', '00135_843.png', '00947_668.png', '00236_546.png', '00083_97.png', '00304_498.png', '00333_851.png', '00575_762.png', '00839_759.png', '00858_922.png', '00148_597.png', '00094_991.png', '00040_525.png', '00970_928.png', '00893_895.png', '00830_821.png', '00036_760.png', '00874_703.png', '00198_409.png', '00157_415.png', '00087_362.png', '00096_603.png', '00779_628.png', '00466_504.png', '00932_317.png', '00991_406.png', '00479_967.png', '00360_479.png', '00624_474.png', '00440_472.png', '00460_347.png', '00518_347.png', '00447_630.png', '00095_887.png', '00679_307.png', '00301_829.png', '00817_511.png', '00772_908.png', '00842_853.png', '00362_227.png', '00412_971.png', '00451_476.png', '00508_805.png', '00877_979.png', '00826_989.png', '00395_326.png', '00354_741.png', '00838_458.png', '00372_743.png', '00660_259.png', '00952_978.png', '00911_319.png', '00457_57.png', '00430_628.png', '00270_989.png', '00946_421.png', '00117_581.png', '00472_874.png', '00589_663.png', '00498_981.png', '00104_287.png', '00807_897.png', '00687_562.png', '00810_425.png', '00760_979.png', '00486_652.png', '00069_467.png', '00554_975.png', '00349_400.png', '00152_51.png', '00031_251.png', '00908_483.png', '00180_546.png', '00758_327.png', '00620_319.png', '00585_874.png', '00167_17.png', '00260_425.png', '00969_436.png', '00381_884.png', '00107_805.png', '00643_917.png', '00698_308.png', '00035_663.png', '00039_692.png', '00111_471.png', '00359_833.png', '00997_468.png', '00590_528.png', '00782_903.png', '00277_317.png', '00428_50.png', '00907_404.png', '00166_94.png', '00859_406.png', '00452_762.png', '00151_719.png', '00232_304.png', '00980_560.png', '00353_717.png', '00327_829.png', '00901_858.png', '00474_562.png', '00150_734.png', '00122_873.png', '00700_671.png', '00188_595.png', '00649_12.png', '00401_654.png', '00504_9.png', '00316_472.png', '00394_877.png', '00692_785.png', '00652_318.png', '00505_616.png', '00433_49.png', '00445_904.png', '00576_571.png', '00234_142.png', '00642_668.png', '00674_656.png', '00734_978.png', '00805_403.png', '00438_981.png', '00925_976.png', '00738_547.png', '00024_129.png', '00716_580.png', '00485_751.png', '00290_565.png', '00812_912.png', '00621_309.png', '00369_120.png', '00283_667.png', '00984_970.png', '00865_94.png', '00085_78.png', '00800_630.png', '00484_967.png', '00168_984.png', '00606_326.png', '00587_569.png', '00965_57.png', '00894_308.png', '00744_104.png', '00278_546.png', '00090_640.png', '00064_133.png', '00159_295.png', '00815_995.png', '00619_984.png', '00722_865.png', '00269_557.png', '00274_560.png', '00564_510.png', '00211_859.png', '00920_980.png', '00127_489.png', '00240_665.png', '00657_661.png', '00781_972.png', '00106_971.png', '00825_497.png', '00120_967.png', '00139_353.png', '00163_306.png', '00248_663.png', '00306_885.png', '00994_141.png', '00189_754.png', '00798_805.png', '00082_396.png', '00641_546.png', '00940_649.png', '00142_437.png', '00357_479.png', '00380_517.png', '00205_663.png', '00197_879.png', '00581_887.png', '00640_581.png', '00190_805.png', '00258_879.png', '00164_637.png', '00872_557.png', '00133_912.png', '00496_873.png', '00915_698.png', '00385_917.png', '00878_736.png', '00584_875.png', '00797_895.png', '00177_858.png', '00373_634.png', '00461_557.png', '00339_107.png', '00200_685.png', '00709_448.png', '00561_656.png', '00987_646.png', '00378_652.png', '00367_97.png', '00998_562.png', '00976_919.png', '00252_749.png', '00883_820.png', '00112_946.png', '00417_777.png', '00414_850.png', '00134_950.png', '00345_146.png', '00408_335.png', '00541_820.png', '00415_470.png', '00334_640.png', '00759_865.png', '00847_331.png', '00450_517.png', '00516_315.png', '00263_912.png', '00410_737.png', '00714_131.png', '00955_479.png', '00737_738.png', '00351_94.png', '00696_946.png', '00814_603.png', '00185_765.png', '00399_304.png', '00255_858.png', '00574_498.png', '00259_301.png', '00849_819.png', '00377_399.png', '00493_317.png', '00785_819.png', '00387_780.png', '00513_654.png', '00670_936.png', '00583_980.png', '00131_746.png', '00109_854.png', '00261_787.png', '00221_570.png', '00617_912.png', '00855_355.png', '00659_436.png', '00771_819.png', '00837_547.png', '00071_882.png', '00237_99.png', '00014_961.png', '00355_557.png', '00296_320.png', '00154_897.png', '00207_759.png', '00161_759.png', '00538_476.png', '00347_888.png', '00750_132.png', '00913_972.png', '00015_541.png', '00524_652.png', '00336_787.png', '00427_533.png', '00202_768.png', '00478_386.png', '00048_805.png', '00208_535.png', '00444_654.png', '00935_421.png', '00442_407.png', '00579_733.png', '00592_402.png'];

  // ===== Helpers =====
  function padIndex(index) { return String(index).padStart(5, '0'); }

  function findFileNameByIndex(index) {
    const padded = padIndex(index);
    const fileName = imageFiles.find(file => file.startsWith(padded));
    if (!fileName) {
      console.warn("No filename found for index:", index, "padded:", padded);
    }
    return fileName || "";
  }

  function toggleSelected(imgEl) {
    imgEl.classList.toggle('selected');
  }

  function setAllSelected(questionDiv, selected) {
    const imgs = questionDiv.querySelectorAll('.selection-image');
    imgs.forEach(img => {
      if (selected) img.classList.add('selected');
      else img.classList.remove('selected');
    });
  }

  // ===== UI Builders =====
  function createImageCell(folder, index) {
    const fileName = findFileNameByIndex(index);
    const cell = document.createElement('div');
    cell.className = 'image-cell';

    const img = document.createElement('img');
    img.src = `${folder.path}/${fileName}`;
    img.alt = folder.name;
    img.className = 'selection-image';
    img.dataset.folder = folder.path;   // path
    img.dataset.name = folder.name;     // "folder name" for counting
    img.onclick = () => toggleSelected(img);

    cell.appendChild(img);
    return cell;
  }

  function populateQuestions() {
    document.getElementById("pageTitle").innerText = config.pageTitle;
    document.getElementById("pageInstructions").innerHTML = config.pageInstructions;

    const questionsContainer = document.getElementById('questions-container');
    questionsContainer.innerHTML = "";

    config.indices.forEach((idx, sampleNumber) => {
      const questionDiv = document.createElement('div');
      questionDiv.className = 'question';
      questionDiv.dataset.sample = sampleNumber + 1;

      const questionTitle = document.createElement('h2');
      questionTitle.textContent = `Sample ${sampleNumber + 1}`;
      questionDiv.appendChild(questionTitle);

      // Bulk select controls (select all 8 together / clear all)
      const bulk = document.createElement('div');
      bulk.className = 'bulk-actions';

      const selectAllBtn = document.createElement('button');
      selectAllBtn.type = "button";
      selectAllBtn.className = "mini-btn";
      selectAllBtn.textContent = "Select all (8)";
      selectAllBtn.onclick = () => setAllSelected(questionDiv, true);

      const clearBtn = document.createElement('button');
      clearBtn.type = "button";
      clearBtn.className = "mini-btn secondary";
      clearBtn.textContent = "Clear";
      clearBtn.onclick = () => setAllSelected(questionDiv, false);

      bulk.appendChild(selectAllBtn);
      bulk.appendChild(clearBtn);
      questionDiv.appendChild(bulk);

      // Grid block
      const wrap = document.createElement('div');
      wrap.className = 'grid-wrap';

      // Column titles row
      const headerRow = document.createElement('div');
      headerRow.className = 'header-row';

      // const emptyCorner = document.createElement('div');
      // emptyCorner.className = 'row-label';
      // emptyCorner.textContent = ""; // left corner blank
      // headerRow.appendChild(emptyCorner);

      config.folders.forEach(folder => {
        const h = document.createElement('div');
        h.className = 'col-header';
        h.textContent = folder.colTitle;
        headerRow.appendChild(h);
      });

      // Single image row (one line, 8 images)
      const imageRow = document.createElement('div');
      imageRow.className = 'image-row';

      // const rowLabel = document.createElement('div');
      // rowLabel.className = 'row-label';
      // rowLabel.textContent = "Select";
      // imageRow.appendChild(rowLabel);

      config.folders.forEach(folder => {
        imageRow.appendChild(createImageCell(folder, idx));
      });

      wrap.appendChild(headerRow);
      wrap.appendChild(imageRow);

      questionDiv.appendChild(wrap);
      questionsContainer.appendChild(questionDiv);
    });
  }

  // ===== Submission / Counting =====
  function submitSurvey() {
    const name = document.getElementById("name").value.trim();
    if (!name) {
      alert("Please enter your name.");
      return;
    }

    let log = `Name: ${name}\n`;
    log += `Date: ${new Date().toISOString()}\n`;
    log += `Total Samples: ${config.indices.length}\n`;
    log += `Folders (columns): ${config.folders.map(f => f.name).join(", ")}\n\n`;

    // Count selections by column (folder "name")
    const folderCounts = {};
    config.folders.forEach(folder => { folderCounts[folder.name] = 0; });

    // Per-sample selections
    const results = {};

    document.querySelectorAll('.question').forEach((question, qIdx) => {
      const sampleId = `Sample ${qIdx + 1}`;
      results[sampleId] = [];

      const selectedImgs = question.querySelectorAll('.selection-image.selected');
      selectedImgs.forEach(img => {
        const folderName = img.dataset.name; // folder "name"
        results[sampleId].push(folderName);
        folderCounts[folderName] += 1;
      });
    });

    // Folder summary
    log += "=== Selected Count by Column (Folder Name) ===\n";
    Object.entries(folderCounts).forEach(([folder, count]) => {
      log += `${folder}: ${count}\n`;
    });

    // Details per sample
    log += "\n=== Selections by Sample ===\n";
    Object.entries(results).forEach(([sample, folders]) => {
      log += `${sample}: ${folders.length ? folders.join(", ") : "(none)"}\n`;
    });

    const blob = new Blob([log], { type: 'text/plain' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = `${name}_userstudy_log.txt`;
    link.click();
  }

  window.onload = populateQuestions;
</script>
</body>
</html>
